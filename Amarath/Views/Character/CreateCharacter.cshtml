@model Amarath.DAL.Models.CharacterViewModel;
@using Amarath.DAL.Models;
@using Amarath.DAL.Data;
@using Microsoft.EntityFrameworkCore;

@inject UserManager<IdentityUserExt> userManager;

@{
    ViewData["Title"] = "CreateCharacter";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Retrieve the different classes
    var optionsBuilder = new DbContextOptionsBuilder<AmarathContext>();
    var db = new AmarathContext(optionsBuilder.Options);

    var cUser = await userManager.GetUserAsync(User);
    var classes = db.Classes;
}

<div class="container">
    <div class="row page-header"><h2>Create Your Character</h2></div>
    <form method="post">
        <div class="row">
            <div class="col-sm-5 col-md-5">
                <div id="classList" class="carousel slide" data-ride="carousel" data-interval="false">
                    <!-- Wrapper for slides -->
                    <div class="carousel-inner" role="listbox">
                        @foreach (var c in classes)
                        {
                            <div class="item @(classes.First() == c ? "active" : String.Empty)" id="@c.ClassTypeID">
                                <img src="https://www.macmillandictionary.com/external/slideshow/full/Grey_full.png" alt="...">
                                <div class="carousel-caption">
                                    <h4>@c.Name</h4>
                                    <h6>@c.Description</h6>
                                </div>
                            </div>
                        }
                    </div>
                    <!-- Controls -->
                    <a class="left carousel-control" href="#classList" role="button" data-slide="prev" onclick="">
                        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#classList" role="button" data-slide="next" onclick="">
                        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="col-sm-7 col-md-7">
                <div class="well">
                    <div class="row">
                        <div class="col-sm-7 col-md-7">
                            <label asp-for="Name">Name</label>
                            <input type="text" asp-for="Name" class="form-control" />
                        </div>
                        <div class="col-sm-5 col-md-5">
                            <label asp-for="Rank">Rank</label>
                            <input type="text" asp-for="Rank" class="form-control text-center" value="1" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <h3><span class="label label-default col-sm-2 col-md-2" id="pointCount">10</span></h3>
                        <div class="col-sm-10 col-md-10">
                            <div class="progress">
                                <div class="progress-bar" id="pointBar" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="10" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <table class="table">
                        <tr>
                            <th class="col-sm-9 col-md-9">Points Assigned</th>
                            <th class="col-sm-2 col-md-2">Points</th>
                            <th class="col-sm-1 col-md-1">Skill Name</th>
                        </tr>
                        @foreach (var c in classes) {
                            <tr id="SSect@(c.ClassTypeID)" name="skills" @(classes.First() == c ? String.Empty : "hidden")>
                                <td>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-minus-sign" id="decSBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                    <div class="col-sm-9 col-md-9">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="SBar@(c.ClassTypeID)" aria-valuenow="@(c.Strength)" aria-valuemin="@(c.Strength)" aria-valuemax="100" style="width: @( c.Strength)%;"></div>
                                        </div>
                                    </div>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-plus-sign" id="incSBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                </td>
                                <td>
                                    <input type="text" asp-for="Strength" id="S@(c.ClassTypeID)" class="form-control text-center" value="@(c.Strength)" disabled />
                                </td>
                                <td>Strength</td>
                            </tr>
                            <tr id="DSect@(c.ClassTypeID)" name="skills" @(classes.First() == c ? String.Empty : "hidden")>
                                <td>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-minus-sign" id="decDBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                    <div class="col-sm-9 col-md-9">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="DBar@(c.ClassTypeID)" aria-valuenow="@(c.Dexterity)" aria-valuemin="@(c.Dexterity)" aria-valuemax="100" style="width: @(c.Dexterity)%;"></div>
                                        </div>
                                    </div>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-plus-sign" id="incDBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                </td>
                                <td>
                                    <input type="text" asp-for="Dexterity" id="D@(c.ClassTypeID)" class="form-control text-center" value="@(c.Dexterity)" disabled />
                                </td>
                                <td>Dexterity</td>
                            </tr>
                            <tr id="ISect@(c.ClassTypeID)" name="skills" @(classes.First() == c ? String.Empty : "hidden")>
                                <td>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-minus-sign" id="decIBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                    <div class="col-sm-9 col-md-9">
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="IBar@(c.ClassTypeID)" aria-valuenow="@(c.Intelligence)" aria-valuemin="@(c.Intelligence)" aria-valuemax="100" style="width: @(c.Intelligence)%;"></div>
                                        </div>
                                    </div>
                                    <a class="btn btn-lg col-sm-1 col-md-1 glyphicon glyphicon-plus-sign" id="incSBar@(c.ClassTypeID)" onclick="updateSkill(this.id);" style="padding:0px;"></a>
                                </td>
                                <td>
                                    <input type="text" asp-for="Intelligence" id="I@(c.ClassTypeID)" class="form-control text-center" value="@(c.Intelligence)" disabled/>
                                </td>
                                <td>Intelligence</td>
                            </tr>
                        }
                        <tr>
                            <td>
                                <div class="col-sm-1 col-md-1"></div>
                                <div class="col-sm-9 col-md-9">
                                    <div class="progress" id="health">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;"></div>
                                    </div>
                                </div>
                                <div class="col-sm-1 col-md-1"></div>
                            </td>
                            <td><input type="text" asp-for="CurrentHealth" class="form-control text-center" value="100" disabled /></td>
                            <td>Health</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <input class="btn btn-primary pull-right" type="submit" style="margin-right:1em;" asp-area="" asp-controller="Character" asp-action="CreateCharacter" value="" />
        </div>
    </form>
</div>

<script>
    var maxNewPoints = 20;
    window.onload = function () {
        $("#pointCount").text(Number(maxNewPoints));
        $("#pointBar").attr('aria-valuenow', maxNewPoints);
        $("#pointBar").attr('aria-valuemax', maxNewPoints);

        $("#classList").bind('slid.bs.carousel', function (event) {
            var currClass = $("#classList .active")[0].id;
            $('[name="skills"]').attr("hidden", "");
            $("#SSect" + currClass).removeAttr("hidden");
            $("#DSect" + currClass).removeAttr("hidden");
            $("#ISect" + currClass).removeAttr("hidden");
        });
    };


    function updateSkill(id) {
        var operator = id.substring(0, 3); // inc, dec
        var skill = id.substring(3, 4); // S, D, I
        var classId = id.substring(id.length - 1); // 1, 2, 3, ...
        var progressBar = "#" + id.substring(3);

        if (operator == "inc" && Number($(progressBar).attr('aria-valuenow')) < Number($(progressBar).attr('aria-valuemax'))
            && Number($("#pointBar").attr("aria-valuenow")) > 0
        )
        {
            $(progressBar).attr('aria-valuenow', Number($(progressBar).attr('aria-valuenow')) + 1);
            $(progressBar).attr("style", "width:" + Number($(progressBar).attr('aria-valuenow')) + "%;");
            $("#"+skill+classId).val($(progressBar).attr('aria-valuenow'));
            $("#pointCount").text(Number($("#pointCount").text()) - 1);
        }
        else if (operator == "dec" && Number($(progressBar).attr('aria-valuenow')) > Number($(progressBar).attr('aria-valuemin'))
            && Number($("#pointBar").attr("aria-valuenow")) < maxNewPoints
        )
        {
            $(progressBar).attr('aria-valuenow', Number($(progressBar).attr('aria-valuenow')) - 1);
            $(progressBar).attr("style", "width:" + Number($(progressBar).attr('aria-valuenow')) + "%;");
            $("#"+skill+classId).val($(progressBar).attr('aria-valuenow'));
            $("#pointCount").text(Number($("#pointCount").text()) + 1);
        }

        // Update total points available
        $("#pointBar").attr("aria-valuenow", Number($("#pointCount").text()));
        $("#pointBar").attr('aria-valuemax', Number($("#pointCount").text()));
        $("#pointBar").attr("style", "width:" + (Number($("#pointCount").text()) / maxNewPoints) * 100 + "%;");
    }
</script>